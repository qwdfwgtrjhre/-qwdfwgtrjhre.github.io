<!DOCTYPE html>
<html>
<head>
    <title>Data Page</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
</head>
<body>
    <h1>Welcome to Data Page</h1>
    <p id="message"></p>
    <p>This is the data page content.</p>

    <script>
       // window.onload = function() {
       //     showMessage(); // 顯示儲存的訊息
      //  };

      //  function showMessage() {
      //      var storedMessage = localStorage.getItem("message");   
      //  }
        var mqttBroker = "broker.emqx.io";
        var mqttPort = 8084;
        var mqttTopic = "web_input_response";
        client = new Paho.MQTT.Client("wss://" + mqttBroker + ":" + mqttPort + "/mqtt", "web_client");

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        client.connect({ onSuccess: onConnect });

        function onConnect() {
            var storedMessage = localStorage.getItem("message"); 
            console.log("Connected to MQTT broker");
            console.log(storedMessage);
            client.subscribe(mqttTopic);
            if (storedMessage !== "true"){ 
                 檢查是否需要輸入密碼
                checkIfPasswordIsRequired();
            }
            localStorage.removeItem("message"); // 清除訊息
        }
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection lost: " + responseObject.errorMessage);
            }
        }

        function onMessageArrived(message) {
            var payload = message.payloadString;
            console.log(message.payloadString);
            if (payload === "true") {
                // 如果已經在 data_page.html，不進行任何操作
                if (window.location.href.includes("wangdoordata.html")) {
                    return;
                }
                // 導向到允許進入的頁面
                window.location.href = "https://qwdfwgtrjhre.github.io/wangdoordata.html";
            } else {
                // 導向到密碼錯誤的頁面或做其他處理
                alert("Incorrect password. Please try again.");
              //  checkIfPasswordIsRequired()
            }
        }
        function checkIfPasswordIsRequired() {
            // 檢查是否需要輸入密碼的邏輯
            var needPassword = true; // 假設需要輸入密碼
            if (needPassword && !window.location.href.includes("login.html")) {
                // 如果需要輸入密碼，且不在 password_page.html，則跳轉到密碼輸入頁面
                window.location.href = "https://qwdfwgtrjhre.github.io/login.html";
            }
        }
        </script>
    </body>

</html>
