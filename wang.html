<!DOCTYPE html>
<html>
<head>
    <title>WANG WANG CORP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸš¾</text></svg>"></link>
</head>
<tbody>
    <h1>WANG WANG CORP DATA:</h1>
    <table id="data-table"  >
        <thead>
            <tr>
	        <th style="border: 1px solid;" > æ™‚é–“ </th>
                <th style="border: 1px solid;"> UID </th>
                <th style="border: 1px solid;"> è¨±å¯ </th>
		<th style="border: 1px solid;"> ç…§ç‰‡ </th>
                <div id="message"></div>
		<input type="text" id="input-message">
                <button id="sendButton" onclick="startCountdownAndSend()">è¼¸å…¥å¯†ç¢¼é–‹é–€</button>
		<span id="countdown"></span>
		<span id="msg1"></span>
            </tr>
        </thead>
    </table>
</tbody>
<body>
    <p id="pass"></p>
    <div id="topic1-data"></div>
    <div id="topic2-data"></div>
    <script>
         
	// è¿”å›ç™»å…¥ä»‹é¢
	var storedMessage = localStorage.getItem("pass"); 
        if (storedMessage !== "true"){ 
            // æª¢æŸ¥æ˜¯å¦éœ€è¦è¼¸å…¥å¯†ç¢¼
            checkIfPasswordIsRequired();
        }
        localStorage.removeItem("pass"); // æ¸…é™¤è¨Šæ¯

	var countdownInterval;
        var data1;
        var countdownTime = 5; // å€’è®¡æ—¶æ—¶é—´ï¼Œå•ä½ï¼šç§’
        var mqttBroker = "broker.emqx.io";
        var mqttPort = 8084;
        var mqttTopic = "WangWangPi/MqttButton";  //å‚³é€è¨Šæ¯
	var mqttTopic1 = "WangWangPi/Code";  //æ¥æ”¶è¼¸å…¥å¯†ç¢¼å¾Œå›å‚³çš„true or false
        var mqttTopic2 = "WangWangPi/Data";  //æ¥æ”¶è³‡æ–™
        // åˆ›å»º MQTT å®¢æˆ·ç«¯å®ä¾‹
	client = new Paho.MQTT.Client("wss://" + mqttBroker + ":" + mqttPort + "/mqtt", "web_client");
       // var client = new Paho.MQTT.Client(mqttBroker, mqttPort,  "client-" + Math.round(Math.random(100000000, 1000000000)*1000000000));

	//"clientId"
        // è®¾ç½®è¿æ¥å’Œæ¶ˆæ¯æ¥æ”¶çš„å›è°ƒå‡½æ•°
	
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // è¿æ¥åˆ° MQTT ä»£ç†
        client.connect({ onSuccess: onConnect });
		
	function onConnect() {
            console.log("Connected to MQTT broker");
            // è®¢é˜… MQTT ä¸»é¢˜
	    client.subscribe(mqttTopic1);
            client.subscribe(mqttTopic2);
	}
		
        // MQTT è¿æ¥æˆåŠŸå¤„ç†å‡½æ•°
	function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection lost: " + responseObject.errorMessage);
            }
        }

        // MQTT æ¥æ”¶æ¶ˆæ¯å¤„ç†å‡½æ•°
	function onMessageArrived(message) {
	    var topic = message.destinationName;
            var payload = message.payloadString;
	    if (topic === mqttTopic1) {
	        var data = message.payloadString;
		data1 = data;
		var countdownElement = document.getElementById("countdown");
		var msg1Element = document.getElementById("msg1");
                var sendButton = document.getElementById("sendButton");
		if (data1 == "True") {   
		    sendButton.disabled = true; // ç¦ç”¨å‘é€æŒ‰é’®
		    msg1Element.innerText = "å·²é–‹é–€";
                    var countdownInterval = setInterval(function() {
                        countdownElement.innerText = countdownTime;
                        countdownTime--;
		        if (countdownTime < 0) { 
                            clearInterval(countdownInterval);
                            countdownElement.innerText = "";
                            countdownTime = 5; // é‡ç½®å€’è®¡æ—¶æ—¶é—´
                            countdownInterval = null;
			    data1 = null;
                            sendButton.disabled = false; // å¯ç”¨å‘é€æŒ‰é’®
		        }
		    }, 1000);
		    msg1Element.innerText = "";
                }
		//else if(data1 == "False") 
		  //  msg1Element.innerText = "è¼¸å…¥éŒ¯èª¤";
	    }
	    if (topic === mqttTopic2) {
		var data = JSON.parse(payload);
                if (dataBuffer.length >= 20) {
                    dataBuffer.shift(); // ç§»é™¤æœ€æ—©çš„ä¸€ç­†è³‡æ–™
                }
                dataBuffer.push(data);
                updateTable();
	        /*var data = JSON.parse(message.payloadString); //message.payloadString
                var id = data.id;
                var access = data.access;
                var photoData = data.photo;			   
                // æ·»åŠ æ•°æ®åˆ°è¡¨æ ¼
                var table = document.getElementById("data-table")
                var newRow = table.insertRow();
        	var timeCell = newRow.insertCell(0);
                var idCell = newRow.insertCell(1);
                var accessCell = newRow.insertCell(2);
		var photoCell = newRow.insertCell(3);
	        timeCell.style.border = '1px solid';
	        idCell.style.border = '1px solid';
		accessCell.style.border = '1px solid';
	        timeCell.innerHTML = data.currentTime;
                idCell.innerText = id;
                accessCell.innerText = access;
	        photoCell.innerHTML = '<img src="data:image/jpeg;base64,' + photoData + '" width="100" height="100">'; // åœ¨å•å…ƒæ ¼ä¸­æ˜¾ç¤ºç…§ç‰‡*/
	    }
	}

	function updateTable() {
    var tableBody = document.getElementById("table-body");
    tableBody.innerHTML = ""; // æ¸…ç©ºåŸæœ‰è³‡æ–™
    dataBuffer.forEach(function(data) {
        var newRow = tableBody.insertRow();
        var timeCell = newRow.insertCell(0);
        var idCell = newRow.insertCell(1);
        var accessCell = newRow.insertCell(2);
        var photoCell = newRow.insertCell(3);

        timeCell.style.border = '1px solid';
        idCell.style.border = '1px solid';
        accessCell.style.border = '1px solid';
        timeCell.innerHTML = data.currentTime;
        idCell.innerText = data.id;
        accessCell.innerText = data.access;
        
        // å°‡ç…§ç‰‡ URL æ”¾å…¥ img æ¨™ç±¤ä¸­
        var photoImg = document.createElement("img");
        photoImg.src = data.image_url;
        photoImg.width = 100;
        photoImg.height = 100;
        photoCell.appendChild(photoImg);
    });
}

        function startCountdownAndSend() {
	    var countdownElement = document.getElementById("countdown");
	    var msg1Element = document.getElementById("msg1");
            var sendButton = document.getElementById("sendButton");
            if (countdownInterval) {
            // å¦‚æœå·²ç»åœ¨å€’è®¡æ—¶ï¼Œåˆ™è¿”å›ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»å‘é€æ•°æ®
            return;
            }
	    sendDataToMqtt();		
	}
		
        function sendDataToMqtt() {
	    var valueToSend = "opendoor";  // æ›¿æ›ç‚ºä½ æƒ³è¦å‚³é€çš„å€¼
	    //var message = document.getElementById("input-message").value;
	    if (client.isConnected()) {
		var mqttMessage = new Paho.MQTT.Message(valueToSend);    
                //var mqttMessage = new Paho.MQTT.Message(message);
                mqttMessage.destinationName = mqttTopic;
                client.send(mqttMessage);
	    }
	    else {
                console.log("MQTT client is not connected.");
            }
	}
	function checkIfPasswordIsRequired() {
            // æª¢æŸ¥æ˜¯å¦éœ€è¦è¼¸å…¥å¯†ç¢¼çš„é‚è¼¯
            var needPassword = true; // å‡è¨­éœ€è¦è¼¸å…¥å¯†ç¢¼
            if (needPassword && !window.location.href.includes("login.html")) {
                // å¦‚æœéœ€è¦è¼¸å…¥å¯†ç¢¼ï¼Œä¸”ä¸åœ¨ password_page.htmlï¼Œå‰‡è·³è½‰åˆ°å¯†ç¢¼è¼¸å…¥é é¢
                window.location.href = "https://wangwangdoor.github.io/login.html";
            }
        }
    </script>
</body>

</html>
